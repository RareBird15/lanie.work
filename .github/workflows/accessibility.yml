name: Accessibility Scan

on:
  workflow_dispatch:
    inputs:
      threshold:
        description: "Fail the job when violations >= this severity (minor|moderate|serious|critical)"
        required: false
        default: "serious"
  pull_request:
  push:

jobs:
  build-and-accessibility:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install Ruby dependencies
        run: bundle install --jobs 4 --retry 3

      - name: Build site
        run: bundle exec jekyll build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pa11y-ci
        run: npm install -g pa11y-ci

      - name: Serve built site
        run: npx http-server ./_site -p 4001 -c-1 &
      - name: Prepare reports directory
        run: mkdir -p reports

      - name: Run accessibility checks (pa11y-ci)
        run: |
          # Ensure pa11y output is captured so artifacts can be uploaded and published
          pa11y-ci --config .pa11yci.json 2>&1 | tee pa11y-output.txt || true

      - name: Summarize pa11y output
        run: |
          echo "# Pa11y output" > reports/PA11Y_SUMMARY.md
          if [ -f pa11y-output.txt ]; then
            cat pa11y-output.txt >> reports/PA11Y_SUMMARY.md
          else
            echo "No pa11y output captured." >> reports/PA11Y_SUMMARY.md
          fi

      - name: Upload accessibility reports
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-reports
          path: |
            reports/**
            pa11y-output.txt
            lh-*.json
            accessibility-reports/**

      - name: Check Axe violations against threshold
        if: always()
        env:
          THRESHOLD: ${{ github.event.inputs.threshold || 'serious' }}
        run: |
          case "$THRESHOLD" in
            minor) MIN=1;;
            moderate) MIN=2;;
            serious) MIN=3;;
            critical) MIN=4;;
            *) echo "Unknown threshold '$THRESHOLD'"; exit 1;;
          esac

          count=0
          for f in reports/axe-*.json; do
            [ -f "$f" ] || continue
            add=$(jq --argjson min "$MIN" '[.violations[] | select((if .impact=="critical" then 4 elif .impact=="serious" then 3 elif .impact=="moderate" then 2 elif .impact=="minor" then 1 else 0 end) >= $min)] | length' "$f" 2>/dev/null || echo 0)
            count=$((count + add))
          done
          echo "Violations at or above $THRESHOLD: $count"
          if [ "$count" -gt 0 ]; then
            echo "Failing job due to violations >= $THRESHOLD"
            exit 1
          fi

      - name: Publish accessibility artifacts to PR (create gist + comment)
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const gh = github;
            const repo = context.repo;
            const files = {};
            const reportDir = path.join(process.cwd(), 'reports');
            if (fs.existsSync(reportDir)) {
              for (const name of fs.readdirSync(reportDir)) {
                const full = path.join(reportDir, name);
                if (fs.statSync(full).isFile()) {
                  try {
                    const content = fs.readFileSync(full, 'utf8');
                    files[`reports/${name}`] = { content };
                  } catch (e) {
                    core.warning(`Failed to read report file ${full}: ${e.message}`);
                  }
                }
              }
            }
            const pa11yPath = path.join(process.cwd(), 'pa11y-output.txt');
            if (fs.existsSync(pa11yPath)) {
              files['pa11y-output.txt'] = { content: fs.readFileSync(pa11yPath, 'utf8') };
            }
            if (Object.keys(files).length === 0) {
              core.info('No artifact files found to publish as gist.');
              return;
            }
            // Try to create a public gist. GITHUB_TOKEN often lacks 'gists' scope, so fall back to posting a PR comment with the run link.
            try {
              const gist = await gh.rest.gists.create({ files, public: true, description: `Accessibility artifacts for ${repo.owner}/${repo.repo} (run ${context.runId})` });
              const gistUrl = gist.data.html_url;
              if (context.payload.pull_request) {
                const prNumber = context.payload.pull_request.number;
                const body = `Accessibility artifacts for run ${context.runId}: ${gistUrl}`;
                await gh.rest.issues.createComment({ owner: repo.owner, repo: repo.repo, issue_number: prNumber, body });
              } else {
                core.info(`Gist created: ${gistUrl}`);
              }
            } catch (err) {
              core.warning(`Gist creation failed: ${err.message}`);
              // Fallback: post a PR comment linking to the Actions run page where artifacts are available.
              if (context.payload.pull_request) {
                const prNumber = context.payload.pull_request.number;
                const runUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${context.runId}`;
                const body = `Accessibility artifacts for run ${context.runId} are available on the Actions run page: ${runUrl}`;
                await gh.rest.issues.createComment({ owner: repo.owner, repo: repo.repo, issue_number: prNumber, body });
                core.info(`Posted fallback PR comment linking to run ${context.runId}`);
              } else {
                const runUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${context.runId}`;
                core.info(`Artifacts available at: ${runUrl}`);
              }
            }
